name: Build, Test, and Release Plugin

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # --------------------------
  # Job 1: Build the plugin
  # --------------------------
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.project_version.outputs.version }}
      name: ${{ steps.project_name.outputs.name }}

    steps:
      - uses: actions/checkout@v4

      # Set up Java 21 for Maven
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # Extract project version
      - name: Extract version
        id: project_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Extract project name dynamically
      - name: Extract project name
        id: project_name
        run: |
          NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          echo "name=$NAME" >> $GITHUB_OUTPUT

      # Build plugin
      - name: Build plugin
        run: mvn -U clean package

      # Upload JAR artifact dynamically
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-jar
          path: target/${{ steps.project_name.outputs.name }}-*.jar

  # --------------------------
  # Job 2: Test plugin on MC 1.16.5+
  # --------------------------
  test:
    needs: build
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        mc:
          - "1.16.5"
          - "1.20.4"

    steps:
      - uses: actions/checkout@v4

      # Download built plugin dynamically
      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: plugin-jar
          path: plugins

      # Set Java for the server
      - name: Set Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.mc == '1.20.4' && '21' || '16' }}

      # Build Spigot server via BuildTools
      - name: Build Spigot ${{ matrix.mc }} server
        run: |
          mkdir -p server
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
          java -jar BuildTools.jar --rev ${{ matrix.mc }}
          cp spigot-${{ matrix.mc }}.jar server/spigot.jar
        working-directory: ${{ github.workspace }}

      # Accept EULA
      - name: Accept EULA
        run: echo "eula=true" > server/eula.txt

      # Start server and test plugin dynamically
      - name: Start server and test plugin
        run: |
          mkdir -p server/plugins
          cp plugins/${{ needs.build.outputs.name }}-*.jar server/plugins/
          cd server
          timeout 60s java -jar spigot.jar nogui || true

      # Verify plugin loaded dynamically
      - name: Verify plugin loaded
        run: |
          grep -q "\[${{ needs.build.outputs.name }}\] Enabling ${{
            needs.build.outputs.name
          }}" server/logs/latest.log

  # --------------------------
  # Job 3: Release if tests pass
  # --------------------------
  release:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download built plugin dynamically
      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: plugin-jar
          path: target

      # Create GitHub Release dynamically
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: ${{ needs.build.outputs.name }} v${{ needs.build.outputs.version }}
          prerelease: ${{ contains(needs.build.outputs.version, 'SNAPSHOT') }}
          files: target/${{ needs.build.outputs.name }}-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
