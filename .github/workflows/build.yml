name: Build, Test, and Release ItemCore

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # --------------------------
  # Job 1: Build the plugin
  # --------------------------
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.project_version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      # Java 8 JUST for BuildTools
      - name: Set up Java 8 (BuildTools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 8

      # Build Spigot 1.9.4 dependencies (initial build for Maven)
      - name: Build Spigot 1.9.4 dependencies
        run: |
          mkdir -p buildtools
          cd buildtools
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
          java -jar BuildTools.jar --rev 1.9.4

      # Switch to Java 21 for Maven
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # Extract version
      - name: Extract version
        id: project_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Build plugin
      - name: Build plugin
        run: mvn -U clean package

      # Upload JAR artifact
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: itemcore-jar
          path: target/ItemCore-*.jar

  # --------------------------
  # Job 2: Test across MC versions
  # --------------------------
  test:
    needs: build
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        mc:
          - "1.9.4"
          - "1.12.2"
          - "1.16.5"
          - "1.20.4"

    steps:
      - uses: actions/checkout@v4

      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: itemcore-jar
          path: plugins

      # Java selection for the test server
      - name: Set Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.mc == '1.20.4' && '21' || '8' }}

      # --------------------------
      # Build Spigot server via BuildTools for this version
      # --------------------------
      - name: Build Spigot ${{ matrix.mc }} server
        run: |
          mkdir -p buildtools-${{ matrix.mc }}
          cd buildtools-${{ matrix.mc }}
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
          java -jar BuildTools.jar --rev ${{ matrix.mc }}
          mkdir -p ../../server
          cp spigot-${{ matrix.mc }}.jar ../../server/spigot.jar

      - name: Accept EULA
        run: |
          echo "eula=true" > server/eula.txt

      - name: Start server and test plugin
        run: |
          mkdir -p server/plugins
          cp plugins/ItemCore-*.jar server/plugins/
          timeout 60s java -jar server/spigot.jar nogui || true

      - name: Verify plugin loaded
        run: |
          grep -q "ItemCore.*enabled" server/logs/latest.log

  # --------------------------
  # Job 3: Release if tests pass
  # --------------------------
  release:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: itemcore-jar
          path: target

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: ItemCore v${{ needs.build.outputs.version }}
          prerelease: ${{ contains(needs.build.outputs.version, 'SNAPSHOT') }}
          files: target/ItemCore-*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
