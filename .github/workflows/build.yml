name: Build, Test, and Release Plugin

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # --------------------------
  # Job 1: Build the plugin
  # --------------------------
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.project_info.outputs.version }}
      name: ${{ steps.project_info.outputs.name }}

    steps:
      - uses: actions/checkout@v4

      # Set up Java 21 for Maven
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # Extract name/version and build plugin
      - name: Build plugin and extract info
        id: project_info
        run: |
          # Extract artifactId and version, trim whitespace
          NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout | tr -d '[:space:]')
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | tr -d '[:space:]')

          # Debug output inside shell
          echo "DEBUG (shell): NAME='$NAME'"
          echo "DEBUG (shell): VERSION='$VERSION'"

          # Build plugin
          mvn -U clean package

          # Set GitHub Actions outputs
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Next step: Debug GitHub outputs
      - name: Debug outputs from previous step
        run: |
          echo "DEBUG (GH Actions): Project name = ${{ steps.project_info.outputs.name }}"
          echo "DEBUG (GH Actions): Project version = ${{ steps.project_info.outputs.version }}"
      

      # Upload JAR artifact
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-jar
          path: target/${{ steps.project_info.outputs.name }}-*.jar

  # --------------------------
  # Job 2: Test plugin on MC versions
  # --------------------------
  test:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mc:
          - "1.16.5"
          - "1.20.4"

    steps:
      - uses: actions/checkout@v4

      # Download built plugin dynamically
      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: plugin-jar
          path: plugins

      # Set Java version depending on MC version
      - name: Set Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.mc == '1.20.4' && '21' || '16' }}

      # Build Spigot server via BuildTools
      - name: Build Spigot ${{ matrix.mc }} server
        run: |
          mkdir -p server
          curl -L -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
          java -jar BuildTools.jar --rev ${{ matrix.mc }}
          cp spigot-${{ matrix.mc }}.jar server/spigot.jar
        working-directory: ${{ github.workspace }}

      # Accept EULA
      - name: Accept EULA
        run: echo "eula=true" > server/eula.txt

      # Start server and test plugin
      - name: Start server and test plugin
        run: |
          mkdir -p server/plugins
          cp plugins/${{ needs.build.outputs.name }}-*.jar server/plugins/
          cd server
          timeout 180s java -Dci.mode=true -jar spigot.jar nogui || true

      # Verify plugin loaded
      - name: Verify plugin loaded
        run: |
          grep -q "\[${{ needs.build.outputs.name }}\] Enabling ${{
            needs.build.outputs.name
          }}" server/logs/latest.log

  # --------------------------
  # Job 3: Release if tests pass
  # --------------------------
  release:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download built plugin artifact dynamically
      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: plugin-jar
          path: target

      # Debug outputs (optional)
      - name: Debug build outputs
        run: |
          echo "Project name: ${{ needs.build.outputs.name }}"
          echo "Project version: ${{ needs.build.outputs.version }}"
          ls -la target/

      # Delete existing release asset (optional)
      - name: Delete existing release asset
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ secrets.TOKEN }}
          tag: v${{ needs.build.outputs.version }}
          assets: |
            ${{ needs.build.outputs.name }}-${{ needs.build.outputs.version }}.jar
        continue-on-error: true

      # Create or update GitHub Release
      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: ${{ needs.build.outputs.name }} v${{ needs.build.outputs.version }}
          prerelease: ${{ contains(needs.build.outputs.version, 'SNAPSHOT') }}
          files: target/${{ needs.build.outputs.name }}-*.jar
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
